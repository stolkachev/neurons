<!doctype html>
<html>

<head>
    <title>NNOD Dialog Editor</title>

    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <script type="text/javascript" src="js/vis.js"></script>
    <link href="nnod_editor.css" rel="stylesheet" type="text/css" />
</head>

<body onload="Page_Loaded();">
    <img src="img/256gl.png" height="70" width="270" style="position: absolute; top: 0px; right: 0px;">

    <div id="shapes">
        <img id="starter" src="img/starter.png" height="60" width="60" style="position: absolute; top: 20px; left: 10px; 
        border-color: gray; " onmouseover="over_image(this);" onmouseout="out_image(this);" onmouseup="click_on_image(this);">
        <img id="prompt" src="img/prompt.png" height="60" width="60" style="position: absolute; top: 90px; left: 10px; border-color: rgb(211, 209, 209);" onmouseover="over_image(this);" onmouseout="out_image(this);" onmouseup="click_on_image(this);">
        <img id="sema" src="img/sema.png" height="60" width="60" style="position: absolute; top: 160px; left: 10px; border-color: rgb(169, 231, 167);" onmouseover="over_image(this);" onmouseout="out_image(this);" onmouseup="click_on_image(this);">
        <img id="contexter" src="img/contexter.png" height="60" width="60" style="position: absolute; top: 240px; left: 10px; border-color: rgb(253, 47, 47);" onmouseover="over_image(this);" onmouseout="out_image(this);" onmouseup="click_on_image(this);">
        <img id="answer" src="img/answer.png" height="60" width="60" style="position: absolute; top: 320px; left: 10px; border-color: rgb(174, 214, 241);" onmouseover="over_image(this);" onmouseout="out_image(this);" onmouseup="click_on_image(this);">
    </div>

    <div id="nodes"></div>

    <div id="qrcode" style="position:absolute; left:3pt; bottom:12pt; "></div>

    <div id='input_group' style="position:absolute; left:65pt; top:15pt; ">
        <strong style="color: rgba(110, 114, 111, 0.788)">Question:</strong><br>
        <input type='text' id='qId' size='40' value='' />
        <button style='position: relative;' onClick='ws_send_Q();'>OK</button>
    </div>

    <script type="text/javascript">
        var u_id = 1;
        var userId = 'Guest';
        var token = '1f6601c5-05b8-4da5-9774-ea7362a8fa2e';
        var header = 'nnod://chat/'
        var session_id = '123';
        var ETX = String.fromCharCode(3);
        var ws_Server = 'ws://256gl.com:55438';
        var qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 80,
            height: 80
        });

        var nodes = null;
        var edges = null;
        var network = null;
        var exportValue = null;
        var resizeTimeOut;

        var get_Neurons_Url = "/slq_get_neurons.php?u_id=" + u_id;
        var get_Nerves_Url = "/slq_get_nerves.php?u_id=" + u_id;
        var update_Node_Coordinates_Url = "/slq_update_Node_Coordinates.php?u_id=" + u_id;
        var delete_Node_Url = "/slq_delete_neuron.php?u_id=" + u_id;
        var add_Node_Url = "/slq_add_neuron.php?u_id=" + u_id;

        var neurons = null;
        var nevres = null;
        var current_shape = null;
        var shapes = {
            "starter": "ellipse",
            "prompt": "box",
            "sema": "circle",
            "contexter": "star",
            "answer": "database"
        };
        var shapes_colors = {
            "starter": "#FADBD8",
            "prompt": "#E5E7E9",
            "sema": "#A9DFBF",
            "contexter": "#C5000B",
            "answer": "#AED6F1"
        };

        var container = document.getElementById('nodes');
        var options = null;
        var data_nodes = null;



        function draw() {
            data = {
                nodes: nodes,
                edges: edges
            };

            options = {
                autoResize: true,

                nodes: {
                    shape: 'circle'
                },
                edges: {
                    color: 'gray',
                    smooth: false,
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1,
                            type: 'arrow'
                        }
                    }
                },
                groups: {
                    starter: {
                        shape: 'ellipse',
                        color: '#FADBD8'
                    },
                    prompt: {
                        shape: 'box',
                        color: '#E5E7E9'
                    },
                    sema: {
                        shape: 'circle',
                        color: '#A9DFBF'
                    },
                    contexter: {
                        shape: 'star',
                        color: '#C5000B'
                    },
                    answer: {
                        shape: 'database',
                        color: '#AED6F1'
                    }
                },
                physics: {
                    enabled: false
                },
                interaction: {
                    hover: true,
                    zoomView: true
                },
                manipulation: {
                    enabled: true,
                    addNode: onAddNode,
                    addEdge: onAddEge,
                    deleteNode: onDeleteNode,
                    deleteEdge: onDeleteEdge
                },
                layout: {
                    randomSeed: undefined,
                    improvedLayout: true
                }
            };
            network = new vis.Network(container, data, options);

            network.on("click", function(params) {
                // var nodes = objectToArray(network.getPositions());
                // nodes.forEach(addConnections);
                // exportValue = JSON.stringify(nodes, undefined, 2);

            });
            network.on("doubleClick", function(params) {
                params.event = "[original event]";
                // document.getElementById('eventSpan').innerHTML = '<h2>doubleClick event:</h2>' + JSON.stringify(params, null, 4);
                alert(JSON.stringify(params, null, 4))
            });

            network.on("dragEnd", function(params) {
                ondragEnd(params);
            });
        }

        window.onresize = function(event) {
            event.stopPropagation();
            event.preventDefault();
            clearTimeout(resizeTimeOut);
            resizeTimeOut = setTimeout(Redraw, 500);
            return false;
        };

        function Page_Loaded() {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", get_Neurons_Url, false);
            xmlHttp.send(null);
            neurons = xmlHttp.responseText;
            xmlHttp.open("GET", get_Nerves_Url, false);
            xmlHttp.send(null);
            nevres = xmlHttp.responseText;
            var a_neurons = neurons.split("\n");
            var a_nerves = nevres.split("\n");

            nodes = new vis.DataSet();
            a_neurons.forEach(function(element) {
                var parts = element.split("\t");
                if (parts.length < 5) {
                    return;
                }
                var grp = parts[2].toLowerCase();
                if (grp == "question") grp = "prompt";
                nodes.add({
                    id: parts[0],
                    group: grp,
                    label: parts[3],
                    x: parts[4],
                    y: parts[5]
                });
            })
            edges = new vis.DataSet();
            a_nerves.forEach(function(element) {
                var parts = element.split("\t");
                if (parts.length < 3) {
                    return;
                }
                edges.add({
                    id: parts[0],
                    from: parts[1],
                    to: parts[2]
                });
            })

            //     alert(nevres);

            Init_Draw();
        }

        function Init_Draw() {

            qrcode.makeCode(header + "ws=" + ws_Server + "&session_id=" + session_id);
            var mynetwork = document.getElementById('nodes');
            var x1 = window.innerWidth - 100;
            var y1 = window.innerHeight - 80;
            mynetwork.style.width = x1 + "px";
            mynetwork.style.height = y1 + "px";
            mynetwork.style.left = "90px";
            draw();
            network.fit();
        }

        function Redraw() {
            var mynetwork = document.getElementById('nodes');
            var x1 = window.innerWidth - 100;
            var y1 = window.innerHeight - 80;
            mynetwork.style.width = x1 + "px";
            mynetwork.style.height = y1 + "px";
            mynetwork.style.left = "90px";

            //            network = new vis.Network(container, data, options);
        };

        function objectToArray(obj) {
            return Object.keys(obj).map(function(key) {
                obj[key].id = key;
                return obj[key];
            });
        }

        function addConnections(elem, index) {
            var arr = [];
            edges.forEach(function(element) {
                if (element.from == elem.id) {
                    arr.push(element.to);
                }
            });
            elem.connections = arr;
        }

        function getNodeData(data) {
            var networkNodes = [];
            data.forEach(function(elem, index, array) {
                networkNodes.push({
                    id: elem.id,
                    label: elem.id,
                    x: elem.x,
                    y: elem.y
                });
            });
            return new vis.DataSet(networkNodes);
        }

        function getNodeById(data, id) {
            for (var n = 0; n < data.length; n++) {
                if (data[n].id == id) {
                    return data[n];
                }
            };
            throw 'Can not find id \'' + id + '\' in data';
        }

        function getEdgeData(data) {
            var networkEdges = [];
            data.forEach(function(node) {
                node.connections.forEach(function(connId, cIndex, conns) {
                    networkEdges.push({
                        from: node.id,
                        to: connId
                    });
                    let cNode = getNodeById(data, connId);

                    var elementConnections = cNode.connections;
                    var duplicateIndex = elementConnections.findIndex(function(connection) {
                        return connection == node.id;
                    });
                    if (duplicateIndex != -1) {
                        elementConnections.splice(duplicateIndex, 1);
                    };
                });
            });
            return new vis.DataSet(networkEdges);
        }

        function over_image(obj) {
            if (current_shape != null) return;
            if (obj.border != "4") {
                obj.border = "2"
            }
        };

        function out_image(obj) {
            if (current_shape != null) return;
            if (obj.border != "4") {
                obj.border = "0"
            }
        };

        function click_on_image(obj) {
            document.getElementById('starter').border = "0";
            document.getElementById('prompt').border = "0";
            document.getElementById('sema').border = "0";
            document.getElementById('contexter').border = "0";
            document.getElementById('answer').border = "0";
            if (current_shape == obj.id) {
                current_shape = null;
                return;
            }
            obj.border = "4"
            current_shape = obj.id;
        };

        function ws_send_Q() {
            msg = document.getElementById('qId').value;
            // div.innerHTML = div.innerHTML + "<font color='blue'>" + msg + '</font><br>';
            // ws_iframe_api.ext_send(userId + ETX + msg);
            document.getElementById('qId').value = "";
        };

        // EVENTS:
        function ondragEnd(params) {
            params.event = "[original event]";
            if (params.nodes == "" || params.nodes == undefined) return;
            var node_id = params.nodes;
            var x = params.pointer.canvas.x;
            var y = params.pointer.canvas.y;
            var url = update_Node_Coordinates_Url + "&node_id=" + node_id + "&x=" + x + "&y=" + y;
            var result = synch_XMLHttpRequest(url);
        }

        function onDeleteNode(toBeDeletedData, callback) {
            var node_id = toBeDeletedData.nodes;
            var url = delete_Node_Url + "&node_id=" + node_id;
            var result = synch_XMLHttpRequest(url);
            //    alert(node_id + " " + result);
            callback(toBeDeletedData);
        }

        function onDeleteEdge(toBeDeletedData, callback) {
            alert('onDeleteEdge', toBeDeletedData);
            callback(toBeDeletedData);
        }

        function onAddEge(nodeData, callback) {
            if (current_shape == null) {
                alert("Please select shape of the node!")
                return;
            }
            nodeData.shape = shapes[current_shape];
            nodeData.color = shapes_colors[current_shape];
            nodeData.label = current_shape;
            callback(nodeData);
        }

        function onAddNode(nodeData, callback) {
            if (current_shape == null) {
                alert("Please select shape of the node!")
                return;
            }
            var node_shape = current_shape;
            var x = Math.round(nodeData.x);
            var y = Math.round(nodeData.y);
            var url = add_Node_Url + "&node_shape=" + node_shape + "&x=" + x + "&y=" + y;
            var result = synch_XMLHttpRequest(url);
            nodeData.id = result;
            nodeData.shape = shapes[current_shape];
            nodeData.color = shapes_colors[current_shape];
            nodeData.label = current_shape;
            callback(nodeData);
        }

        // HTTP Requests:

        function synch_XMLHttpRequest(url) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", url, false);
            xmlHttp.send(null);
            var result = xmlHttp.responseText;
            return result;
        }
    </script>

</body>

</html>